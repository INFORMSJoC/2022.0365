function [mae0,mae,mse0,mse,cost0,cost,sl0,sl]=DBCD51bpgg2(x,xx,y,yy,ytrain,ytest,d,p,h,c)
n1=length(x(1,1,1,:,1));
n2=length(x(1,1,:,1,1));
n3=length(x(1,:,1,1,1));
n4=length(x(:,1,1,1,1));
nn2=length(xx(1,1,:,1,1));
h=h(1:n4,1:n1);
p=p(1:n4,1:n1);
d=d(1:n1);
c=c(1:n4,:,1:n1);
s10=(sign(ytrain)+1)/2;
ytrain1=sign(s10);
ytrain2=ytrain1.*ytrain;
s20=(sign(ytest)+1)/2;
ytest1=sign(s20);
ytest2=ytest1.*ytest;
yy=yy(1:n4,:,:,:);
y=y(1:n4,:,:,:);
tic
mae0(:,:,:,n1)=abs(ytrain2(:,:,:,n1)-y(1:n4,:,:,n1));
sl0(:,:,:,n1)=max(min(ytrain2(:,:,:,n1),y(1:n4,:,:,n1)),0)./(y(1:n4,:,:,n1)+(sign(y(1:n4,:,:,n1))-1)*(-exp(100)));
mse0(:,:,:,n1)=mae0(:,:,:,n1).^2;
mae(:,:,:,n1)=abs(ytest2(:,:,:,n1)-yy(1:n4,:,:,n1));
sl(:,:,:,n1)=max(min(ytest2(:,:,:,n1),yy(1:n4,:,:,n1)),0)./(yy(1:n4,:,:,n1)+(sign(yy(1:n4,:,:,n1))-1)*(-exp(100)));
mse(:,:,:,n1)=mae(:,:,:,n1).^2;
s=((sign(ytrain2(:,:,:,n1)-y(:,:,:,n1))+1)./2);
cost01(:,:,:,n1)=repmat(h(:,n1),1,n3,n2).*(ytrain2(:,:,:,n1)-y(:,:,:,n1))+repmat(c(:,:,n1),1,1,n2).*ytrain2(:,:,:,n1);
cost01(:,:,:,n1)=cost01(:,:,:,n1).*s;
s=((sign(-ytrain2(:,:,:,n1)+y(:,:,:,n1))+1)./2);
cost02(:,:,:,n1)=d(n1)*repmat(p(:,n1),1,n3,n2).*(-ytrain2(:,:,:,n1)+y(:,:,:,n1))+repmat(c(:,:,n1),1,1,n2).*ytrain2(:,:,:,n1);
cost02(:,:,:,n1)=cost02(:,:,:,n1).*s;
cost0(:,:,:,n1)=cost01(:,:,:,n1)+cost02(:,:,:,n1);
s=((sign(ytest2(:,:,:,n1)-yy(1:n4,:,:,n1))+1)./2);
cost1(:,:,nn2,n1)=repmat(h(:,n1),1,n3,nn2).*(ytest2(:,:,:,n1)-yy(1:n4,:,:,n1))+repmat(c(:,:,n1),1,1,nn2).*ytest2(:,:,:,n1);
cost1(:,:,nn2,n1)=cost1(:,:,nn2,n1).*s;
s=((sign(-ytest2(:,:,:,n1)+yy(1:n4,:,:,n1))+1)./2);
cost2(:,:,nn2,n1)=d(n1)*repmat(p(:,n1),1,n3,nn2).*(-ytest2(:,:,:,n1)+yy(1:n4,:,:,n1))+repmat(c(:,:,n1),1,1,nn2).*ytest2(:,:,:,n1);
cost2(:,:,nn2,n1)=cost2(:,:,nn2,n1).*s;
cost(:,:,:,n1)=cost1(:,:,:,n1)+cost2(:,:,:,n1);
for tt0=1:n1-1
    tt=n1-tt0;
    s1=0;
    s0=0;
     for t=tt+1:n1
         s0=s0-ytrain2(:,:,:,t)+y(:,:,:,t);
         s1=s1-ytest2(:,:,:,t)+yy(1:n4,:,:,t);
     end
     ss0=s0;
     ss=s1;
     mae0(:,:,:,tt)=abs(ytrain2(:,:,:,tt)-ss0-y(:,:,:,tt));
     sl0(:,:,:,tt)=max(min(ytrain2(:,:,:,tt),y(:,:,:,tt)),0)./(y(:,:,:,tt)+(sign(y(:,:,:,tt))-1)*(-exp(100)));
     mse0(:,:,:,tt)=mae0(:,:,:,tt).^2;
     mae(:,:,:,tt)=abs(ytest2(:,:,:,tt)-ss-yy(:,:,:,tt));
     sl(:,:,:,tt)=max(min(ytest2(:,:,:,tt),yy(:,:,:,tt)),0)./(yy(:,:,:,tt)+(sign(yy(:,:,:,tt))-1)*(-exp(100)));
     mse(:,:,:,tt)=mae(:,:,:,tt).^2;
     s=((sign(ytrain2(:,:,:,1)-ss0-y(:,:,:,1))+1)./2);
     cost01(:,:,:,tt)=repmat(h(:,tt),1,n3,n2).*(ytrain2(:,:,:,tt)-ss0-y(:,:,:,tt))+repmat(c(:,:,tt),1,1,n2).*ytrain2(:,:,:,tt);
     cost01(:,:,:,tt)=cost01(:,:,:,tt).*s;
     s=((sign(-ytrain2(:,:,:,tt)+ss0+y(:,:,:,tt))+1)./2);
     cost02(:,:,:,tt)=d(tt)*repmat(p(:,1),1,n3,n2).*(-ytrain2(:,:,:,tt)+ss0+y(:,:,:,tt))+repmat(c(:,:,tt),1,1,n2).*ytrain2(:,:,:,tt);
     cost02(:,:,:,tt)=cost02(:,:,:,tt).*s;
     cost0(:,:,:,tt)=cost01(:,:,:,tt)+cost02(:,:,:,tt);
     s=((sign(ytest2(:,:,:,tt)-ss-yy(:,:,:,tt))+1)./2);
     cost1(:,:,nn2,tt)=repmat(h(:,tt),1,n3,nn2).*(ytest2(:,:,:,tt)-ss-yy(:,:,:,tt))+repmat(c(:,:,tt),1,1,nn2).*ytest2(:,:,:,tt);
     cost1(:,:,nn2,tt)=cost1(:,:,nn2,tt).*s;
     s=((sign(-ytest2(:,:,:,tt)+ss+yy(:,:,:,tt))+1)./2);
     cost2(:,:,nn2,tt)=d(1)*repmat(p(:,tt),1,n3,nn2).*(-ytest2(:,:,:,tt)+ss+yy(:,:,:,tt))+repmat(c(:,:,tt),1,1,nn2).*ytest2(:,:,:,tt);
     cost2(:,:,nn2,tt)=cost2(:,:,nn2,tt).*s;
     cost(:,:,:,tt)=cost1(:,:,:,tt)+cost2(:,:,:,tt);
end
mae=permute(mae,[1 2 4 3]);
mse=permute(mse,[1 2 4 3]);
cost=permute(cost,[1 2 4 3]);
toc